<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.theme.min.css" />
    <link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.min.css' rel='stylesheet' />
    <link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.print.min.css' rel='stylesheet' media='print' />
    <link href='../node_modules/fullcalendar-scheduler/dist/scheduler.min.css' rel='stylesheet' />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/locale/it.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.min.js'></script>
    <script src='../node_modules/fullcalendar-scheduler/dist/scheduler.min.js'></script>
    <title>3wlab Scheduler</title>
    <script>
    $(function() { // document ready
        var baseMaxEventId = 1000; //oriBBuule ma temporaneo(AA)
        $.ajax({
            url: "/config/1",
            type: "GET",
            success: function(data) {
                baseMaxEventId = data.baseMaxEventId;
                console.log("baseMaxEventId: " + baseMaxEventId);
                console.log("/congig/1: " + JSON.stringify(data));
            }
        })


        $('#calendar').fullCalendar({
            schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source',
            locale: 'it',
            // now: '2017-07-07', //setted for testing pourpose
            now: moment().valueOf(),
            // defaultDate: '2017-05-07',
            navLinks: true, // can click day/week names to navigate views
            editable: true, // enable draggable events
            selectable: true,
            selectHelper: true,
            aspectRatio: 1.8,
            scrollTime: '00:00', // undo default 6am scrollTime
            header: {
                left: 'today prev,next',
                center: 'title',
                right: 'timelineDay,timelineThreeDays,timelineFiveDays,timeline31Days,agendaWeek,month'
            },
            defaultView: 'timelineDay',
            views: {
                timelineThreeDays: {
                    type: 'timeline',
                    duration: {
                        days: 3
                    }
                },
                timelineFiveDays: {
                    type: 'timeline',
                    duration: {
                        days: 5
                    }
                },
                timeline31Days: {
                    type: 'timeline',
                    duration: {
                        days: 31
                    }
                }
            },
            resourceLabelText: 'Risorse',
            resources: { // you can also specify a plain string like 'json/resources.json'
                // url: 'json/resources.json',
                url: '/resources',
                type: 'GET',
                error: function() {
                    $('#script-warning').show();
                }
            },
            // events: { // you can also specify a plain string like 'json/events.json'
            //     // url: 'json/events.json',
            //     url: '/events',
            //     type: 'GET',
            //     // cache: true,
            //     error: function() {
            //         $('#script-warning').show();
            //     }
            // },
            events: function(start, end, timezone, callback) {
                $.ajax({
                    url: '/events',
                    type: 'GET',
                    dataType: "json",
                    data: {
                        start: start.unix(),
                        end: end.unix()
                    },
                    success: function(data) {
                        var events = [];
                        $(data)/*.find('event')*/.each(function() {
                            events.push({
                                id: $(this).attr('id'),
                                resourceId: $(this).attr('resourceId'),
                                start: moment.unix($(this).attr('start')).format("YYYY-MM-DDTHH:mm:ss"),
                                end:  moment.unix($(this).attr('end')).format("YYYY-MM-DDTHH:mm:ss"),
                                title: $(this).attr('title')
                            });
                        });
                        console.log("data fetched: \r\n" + JSON.stringify(data));
                        $('#calendar').fullCalendar('renderEvents', data, true);
                        console.log("events: \r\n" + JSON.stringify(events));
                        callback(events);
                    },
                    error: function() {
                        $('#script-warning').show();
                    }
                });
            },
            eventRender: function(eventData, element) {
                element.css("font-weight:bold");
                console.log("evento creato");
            },
            select: function(start, end, jsEvent, view, resource) {


                var title = prompt('Event Title:');
                var eventData;


                if (title) {
                    eventData = {
                        id: JSON.parse(baseMaxEventId) + 10,
                        resourceId: resource.id,
                        start: start.valueOf(),
                        end: end.valueOf(),
                        title: title
                    };
                    baseMaxEventId = JSON.parse(eventData.id) + 1;

                    console.log(
                        'select callback',
                        start,
                        start.valueOf(),
                        end,
                        end.valueOf(),
                        resource ? resource.title + ', id: ' + resource.id : '(no resource)',
                        jsEvent.originalEvent,
                        eventData,
                        "baseMaxEventId" + JSON.stringify(baseMaxEventId)
                    );

                    $.ajax({
                        url: "/events",
                        type: "POST",
                        traditional: true,
                        data: eventData,
                        dataType: "json",
                        success: function(response) {
                            console.log(response);
                        },
                        error: function(xhr) {
                            debugger;
                            console.log(xhr);
                        }
                    });
                    var baseMaxEventIdObj = {
                        "id": "1",
                        "baseMaxEventId": baseMaxEventId
                    }

                    $.ajax({
                        url: "/config/1",
                        type: "PUT",
                        data: baseMaxEventIdObj,
                        dataType: "json"
                    });


                    $('#calendar').fullCalendar('getResources');
                    $('#calendar').fullCalendar('renderEvent', eventData, true); // stick? = true
                }
                $('#calendar').fullCalendar('unselect');
            },
            // dayClick: function(date, jsEvent, view, resource) {
            //     console.log(
            //         'dayClick',
            //         date.format(),
            //         resource ? resource.title : '(no resource)'
            //     );
            // }
        });

        $('#select-G').on('click', function() {
            $('#calendar').fullCalendar('select', '2017-05-07T02:00:00', '2017-05-07T07:00:00', 'g');
        });
        $('#select-unspecified').on('click', function() {
            $('#calendar').fullCalendar('select', '2017-05-07T02:00:00', '2017-05-07T07:00:00');
        });

    });
    </script>
    <style>
    body {
        margin: 40px 10px;
        padding: 0;
        font-family: "Lucida Grande", Helvetica, Arial, Verdana, sans-serif;
        font-size: 14px;
    }

    #script-warning {
        display: none;
        background: #eee;
        border-bottom: 1px solid #ddd;
        padding: 0 10px;
        line-height: 40px;
        text-align: center;
        font-weight: bold;
        font-size: 12px;
        color: red;
    }

    #loading {
        display: none;
        position: absolute;
        top: 10px;
        right: 10px;
    }

    #calendar {
        max-width: 900px;
        margin: 50px auto;
    }
    </style>
</head>

<body>
    <div id='script-warning'>
        This page should be running from a webserver, to allow fetching from the <code>json/</code> directory.
    </div>
    <div id='loading'>loading...</div>
    <div id='calendar'></div>
    <p style='text-align:center'>
        <button id='select-G'>select G</button>
        <button id='select-unspecified'>select w/o a resource</button>
    </p>
</body>

</html>
